#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

echo "------> Generating .profile.d file to generate credential.json at startup"
mkdir -p $BUILD_DIR/.profile.d
CREDENTIALS=$(cat ${ENV_DIR}/GCP_CREDS | base64 -d)
echo "echo ${CREDENTIALS@Q} > /app/credentials.json > $BUILD_DIR/.profile.d/keap-gcp-creds.sh
chmod +x $BUILD_DIR/.profile.d/keap-gcp-creds.sh


echo "------> Generating .profile.d file to generate gradle.properties at startup"

gradleProps=$(cat <<EOF
ARTIFACTORY_USERNAME=$(cat ${ENV_DIR}/ARTIFACTORY_USERNAME)
ARTIFACTORY_PASSWORD=$(cat ${ENV_DIR}/ARTIFACTORY_PASSWORD)
externalProxyRepositoryPassword=$(cat ${ENV_DIR}/externalProxyRepositoryPassword)
externalProxyRepositoryUsername=$(cat ${ENV_DIR}/externalProxyRepositoryUsername)
EOF
)

echo "mkdir -p ~/.gradle && echo ${gradleProps@Q} > ~/.gradle/gradle.properties > $BUILD_DIR/.profile.d/keap-gradle.sh
chmod +x $BUILD_DIR/.profile.d/keap-gradle.sh


